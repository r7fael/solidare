{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Painel do Doador | SOLIDARE{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'application/css/painel.css' %}">

<div class="painel-container">
    <div class="barra-lateral">
        <div class="perfil-usuario">
            <img src="{% static 'application/images/user-avatar.png' %}" alt="Avatar" class="avatar-usuario">
            <h2>{{ user.nome }}</h2>
            <p>Doador desde {{ user.date_joined|date:"Y" }}</p>
            {% if user.doador %}
            <p class="ocupacao">{{ user.doador.ocupacao }}</p>
            {% endif %}
            
            <div class="resumo-perfil">
                <div class="item-resumo">
                    <span class="numero">R$ {{ total_doacoes|intcomma }}</span>
                    <span class="rotulo">Total Doado</span>
                </div>
                <div class="item-resumo">
                    <span class="numero">{{ doacoes.count }}</span>
                    <span class="rotulo">Doações</span>
                </div>
            </div>
        </div>
        
        <nav class="navegacao-lateral">
            <ul>
                <li><a href="#" class="ativo" data-secao="inicio">Início</a></li>
                <li><a href="{% url 'metricas' %}" data-secao="metricas">Métricas</a></li>
                <li><a href="{% url 'minhas_doacoes' %}" data-secao="doacoes">Minhas Doações</a></li>
                <li><a href="{% url 'nova_doacao' %}" data-secao="nova-doacao">Nova Doação</a></li>
                <li><a href="{% url 'detalhes_' %}" data-secao="mensagens">Mensagens</a></li>
            </ul>
        </nav>
    </div>

    <div class="conteudo-principal">
        
        
        <div id="mensagens" class="secao-conteudo">
            <div class="cabecalho-secao">
                <h1>Minhas Mensagens</h1>
                <button class="botao-primario" onclick="mostrarFormularioMensagem()">Nova Mensagem</button>
            </div>
            
            <div class="filtros-mensagens">
                <div class="grupo-filtro">
                    <label for="filtro-status-mensagem">Status:</label>
                    <select id="filtro-status-mensagem">
                        <option value="TODAS">Todas</option>
                        <option value="AGUARDANDO">Aguardando Aprovação</option>
                        <option value="APROVADO">Aprovadas</option>
                        <option value="REJEITADO">Rejeitadas</option>
                    </select>
                </div>
            </div>
            
            <div class="lista-mensagens">
                {% for mensagem in mensagens %}
                <div class="cartao-mensagem" data-status="{{ mensagem.status|lower }}">
                    <div class="cabecalho-mensagem">
                        <h3>Para: {{ mensagem.destinatario.nome }}</h3>
                        <span class="status-mensagem status-{{ mensagem.status|lower }}">
                            {{ mensagem.get_status_display }}
                        </span>
                    </div>
                    <div class="corpo-mensagem">
                        <h4>{{ mensagem.assunto }}</h4>
                        <p>{{ mensagem.conteudo }}</p>
                    </div>
                    <div class="rodape-mensagem">
                        <span class="data-mensagem">
                            {% if mensagem.data_envio %}
                                Enviada em {{ mensagem.data_envio|date:"d/m/Y" }}
                            {% else %}
                                Data não disponível
                            {% endif %}
                        </span>
                        {% if mensagem.status == 'REJEITADO' and mensagem.motivo_rejeicao %}
                        <div class="motivo-rejeicao">
                            <strong>Motivo da rejeição:</strong> {{ mensagem.motivo_rejeicao }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="sem-mensagens">
                    <p>Nenhuma mensagem enviada ainda</p>
                </div>
                {% endfor %}
            </div>
            
            <div id="formulario-mensagem" class="formulario-mensagem" style="display: none;">
                <h2>Enviar Mensagem</h2>
                <form id="form-mensagem" method="POST" action="{% url 'mensagens:criar_mensagem' %}">
                    {% csrf_token %}
                    
                    <div class="campo-formulario">
                        <label for="destinatario-mensagem">Beneficiário</label>
                        <select id="destinatario-mensagem" name="destinatario" required>
                            <option value="">Selecione o beneficiário</option>
                            {% for beneficiario in beneficiarios_disponiveis %}
                            <option value="{{ beneficiario.id }}">{{ beneficiario.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="campo-formulario">
                        <label for="assunto-mensagem">Assunto</label>
                        <input type="text" id="assunto-mensagem" name="assunto" required placeholder="Ex: Doação de roupas">
                    </div>
                    
                    <div class="campo-formulario">
                        <label for="conteudo-mensagem">Mensagem</label>
                        <textarea id="conteudo-mensagem" name="conteudo" rows="5" required placeholder="Escreva sua mensagem aqui..."></textarea>
                    </div>
                    
                    <div class="acoes-formulario">
                        <button type="submit" class="botao-primario" id="btn-enviar-mensagem">Enviar Mensagem</button>
                        <button type="button" class="botao-secundario" onclick="ocultarFormularioMensagem()">Cancelar</button>
                    </div>
                </form>
            </div>
            
         
            <div id="modal-confirmacao" class="modal" style="display: none;">
                <div class="modal-conteudo">
                    <span class="fechar-modal" onclick="fecharModal()">&times;</span>
                    <h3>Mensagem Enviada com Sucesso!</h3>
                    <p>Sua mensagem foi enviada e está aguardando aprovação.</p>
                    <p>Você receberá uma notificação quando ela for aprovada.</p>
                    <button class="botao-primario" onclick="fecharModal()">OK</button>
                </div>
            </div>
        </div>
    </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
      
        document.querySelectorAll('.navegacao-lateral a[data-secao]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                mostrarSecao(this.getAttribute('data-secao'));
            });
        });
    
     
        document.querySelectorAll('.filtros select').forEach(select => {
            select.addEventListener('change', function() {
                const status = document.getElementById('filtro-status').value;
                const destino = document.getElementById('filtro-destino').value;
                
                document.querySelectorAll('.tabela-doacoes tbody tr').forEach(linha => {
                    const linhaStatus = linha.getAttribute('data-status');
                    const linhaDestino = linha.getAttribute('data-destino');
                    
                    const mostraStatus = status === 'TODOS' || linhaStatus === status;
                    const mostraDestino = destino === 'TODOS' || linhaDestino === destino;
                    
                    linha.style.display = (mostraStatus && mostraDestino) ? '' : 'none';
                });
            });
        });
    
        
        const filtroStatusMensagem = document.getElementById('filtro-status-mensagem');
        if (filtroStatusMensagem) {
            filtroStatusMensagem.addEventListener('change', function() {
                const status = this.value.toLowerCase();
                
                document.querySelectorAll('.lista-mensagens .cartao-mensagem').forEach(cartao => {
                    const cartaoStatus = cartao.getAttribute('data-status');
                    
                    if (status === 'todas') {
                        cartao.style.display = '';
                    } else {
                        cartao.style.display = cartaoStatus === status ? '' : 'none';
                    }
                });
            });
        }
    
   
        const valorInput = document.getElementById('valor');
        if (valorInput) {
            valorInput.addEventListener('blur', function() {
                let value = this.value.replace(/\D/g, '');
                value = (value / 100).toFixed(2) + '';
                value = value.replace(".", ",");
                value = value.replace(/(\d)(\d{3})(\d{3}),/g, "$1.$2.$3,");
                value = value.replace(/(\d)(\d{3}),/g, "$1.$2,");
                this.value = value;
            });
        }
    
        const formMensagem = document.getElementById('form-mensagem');
        if (formMensagem) {
            formMensagem.addEventListener('submit', function(e) {
                enviarMensagem(e, this);
            });
        }
    });
    
    
    function mostrarSecao(secaoId) {
        document.querySelectorAll('.navegacao-lateral a').forEach(link => {
            link.classList.remove('ativo');
        });
        document.querySelector(`.navegacao-lateral a[data-secao="${secaoId}"]`).classList.add('ativo');
        
        document.querySelectorAll('.secao-conteudo').forEach(secao => {
            secao.classList.remove('ativo');
        });
        document.getElementById(secaoId).classList.add('ativo');
    }
    
    function mostrarFormularioMensagem() {
        document.getElementById('formulario-mensagem').style.display = 'block';
        window.scrollTo({
            top: document.getElementById('formulario-mensagem').offsetTop,
            behavior: 'smooth'
        });
    }
    
    function ocultarFormularioMensagem() {
        document.getElementById('formulario-mensagem').style.display = 'none';
    }
    
    function mostrarModalConfirmacao() {
        document.getElementById('modal-confirmacao').style.display = 'block';
    }
    
    function fecharModal() {
        document.getElementById('modal-confirmacao').style.display = 'none';
    }
    
    function mostrarModalErro(mensagem) {
        const erroElement = document.getElementById('mensagem-erro');
        if (erroElement) {
            erroElement.textContent = mensagem;
            document.getElementById('modal-erro').style.display = 'block';
        } else {
            alert(mensagem);
        }
    }
    
    function fecharModalErro() {
        document.getElementById('modal-erro').style.display = 'none';
    }
    
   
    function enviarMensagem(event, form) {
        event.preventDefault();
        
        const submitButton = form.querySelector('#btn-enviar-mensagem');
        const originalText = submitButton.textContent;
        
       
        const destinatario = form.querySelector('#destinatario-mensagem').value;
        const assunto = form.querySelector('#assunto-mensagem').value.trim();
        const conteudo = form.querySelector('#conteudo-mensagem').value.trim();
        
        if (!destinatario || !assunto || !conteudo) {
            mostrarModalErro('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
    
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="loading"></span> Enviando...';
        
        
        const formData = new FormData();
        formData.append('destinatario', destinatario);
        formData.append('assunto', assunto);
        formData.append('conteudo', conteudo);
        formData.append('csrfmiddlewaretoken', form.querySelector('[name=csrfmiddlewaretoken]').value);
    
        // Configurar timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
    
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            },
            signal: controller.signal
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erro HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarModalConfirmacao();
                form.reset();
                ocultarFormularioMensagem();
                
                if (data.mensagem) {
                    adicionarMensagemNaLista(data.mensagem);
                }
            } else {
                mostrarModalErro(data.error || 'Erro ao processar sua mensagem. Tente novamente.');
            }
        })
        .catch(error => {
            console.error('Erro no envio:', error);
            if (error.name === 'AbortError') {
                mostrarModalErro('Tempo de conexão esgotado. Verifique sua internet e tente novamente.');
            } else {
                mostrarModalErro('Sua mensagem pode ter sido enviada, mas houve um problema na resposta. Verifique sua caixa de mensagens.');
            }
        })
        .finally(() => {
            clearTimeout(timeoutId);
            submitButton.textContent = originalText;
            submitButton.disabled = false;
        });
    }
    

    function adicionarMensagemNaLista(mensagem) {
        const listaMensagens = document.querySelector('.lista-mensagens');
        const semMensagens = listaMensagens.querySelector('.sem-mensagens');
        
        if (semMensagens) {
            semMensagens.remove();
        }
        
        const dataEnvio = mensagem.data_envio ? 
            new Date(mensagem.data_envio).toLocaleDateString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : 
            new Date().toLocaleDateString('pt-BR');
        
        const novaMensagemHTML = `
            <div class="cartao-mensagem" data-status="${mensagem.status.toLowerCase()}">
                <div class="cabecalho-mensagem">
                    <h3>Para: ${mensagem.destinatario_nome}</h3>
                    <span class="status-mensagem status-${mensagem.status.toLowerCase()}">
                        ${mensagem.status_display}
                    </span>
                </div>
                <div class="corpo-mensagem">
                    <h4>${mensagem.assunto}</h4>
                    <p>${mensagem.conteudo}</p>
                </div>
                <div class="rodape-mensagem">
                    <span class="data-mensagem">
                        ${dataEnvio}
                    </span>
                    ${mensagem.motivo_rejeicao ? `<div class="motivo-rejeicao"><strong>Motivo:</strong> ${mensagem.motivo_rejeicao}</div>` : ''}
                </div>
            </div>
        `;
        
        listaMensagens.insertAdjacentHTML('afterbegin', novaMensagemHTML);
    }
</script>
{% endblock %}