{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Painel do Doador | SOLIDARE{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'application/css/painel.css' %}">

<div class="painel-container">
    <div class="barra-lateral">
        <div class="perfil-usuario">
            <img src="{% static 'application/images/user-avatar.png' %}" alt="Avatar" class="avatar-usuario">
            <h2>{{ user.nome }}</h2>
            <p>Doador</p>
            {% if user.doador %}
            <p class="ocupacao">{{ user.doador.ocupacao }}</p>
            {% endif %}
        </div>
        
        <nav class="navegacao-lateral">
            <ul>
                <li><a href="#" class="ativo" data-secao="inicio"><i class="fas fa-home"></i> Início</a></li>
                <li><a href="#" data-secao="metricas"><i class="fas fa-chart-line"></i> Métricas</a></li>
                <li><a href="{% url 'doacoes:minhas_doacoes' %}" data-secao="doacoes"><i class="fas fa-hand-holding-heart"></i> Minhas Doações</a></li>
                <li><a href="#" data-secao="relatorios"><i class="fas fa-file-alt"></i> Relatórios</a></li>
            </ul>
        </nav>
    </div>

    <div class="conteudo-principal">
        <div id="inicio" class="secao-conteudo ativo">
            <div class="cartao-boasvindas">
                <h1>Bem-vindo, {{ user.nome }}!</h1>
                <p>Seu apoio está transformando vidas. Veja abaixo seu impacto:</p>
                
                <div class="estatisticas-impacto">
                    <div class="cartao-estatistica">
                        <h3>R$ {{ total_doacoes|intcomma }}</h3>
                        <p>Total Doado</p>
                    </div>
                    <div class="cartao-estatistica">
                        <h3>{{ pessoas_impactadas }}</h3>
                        <p>Pessoas impactadas</p>
                    </div>
                    <div class="cartao-estatistica">
                        <h3>{{ taxa_empregabilidade }}%</h3>
                        <p>Taxa de empregabilidade</p>
                    </div>
                </div>
                
                <div class="ultimas-doacoes">
                    <h3>Suas últimas doações</h3>
                    {% for doacao in ultimas_doacoes %}
                    <div class="item-doacao">
                        <span class="valor-doacao">R$ {{ doacao.valor|intcomma }}</span>
                        <span class="status-doacao status-{{ doacao.status|lower }}">{{ doacao.get_status_display }}</span>
                    </div>
                    {% empty %}
                    <p>Nenhuma doação recente</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div id="metricas" class="secao-conteudo">
            <div class="container-metricas">
                <h1>Seu Impacto em Números</h1>
                
                <div class="container-grafico">
                    <canvas id="grafico-impacto"></canvas>
                </div>
                
                <div class="grade-metricas">
                    <div class="item-metrica">
                        <i class="fas fa-graduation-cap"></i>
                        <h3>{{ doacoes.count }} Doações</h3>
                        <p>Realizadas</p>
                    </div>
                    <div class="item-metrica">
                        <i class="fas fa-users"></i>
                        <h3>{{ pessoas_impactadas }} Pessoas</h3>
                        <p>Impactadas</p>
                    </div>
                    <div class="item-metrica">
                        <i class="fas fa-briefcase"></i>
                        <h3>{{ taxa_empregabilidade }}%</h3>
                        <p>Empregabilidade</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="doacoes" class="secao-conteudo">
            <div class="cabecalho-doacoes">
                <h1>Minhas Doações</h1>
                <a href="{% url 'doacoes:nova_doacao' %}" class="botao-nova-doacao">
                    <i class="fas fa-plus"></i> Nova Doação
                </a>
            </div>
            
            <div class="tabela-doacoes">
                <table>
                    <thead>
                        <tr>
                            <th>Valor</th>
                            <th>Método</th>
                            <th>Destino</th>
                            <th>Status</th>
                            <th>Comprovante</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for doacao in doacoes %}
                        <tr>
                            <td>R$ {{ doacao.valor|intcomma }}</td>
                            <td>{{ doacao.get_metodo_display }}</td>
                            <td>{{ doacao.get_destino_display }}</td>
                            <td>
                                <span class="status-{{ doacao.status|lower }}">
                                    {{ doacao.get_status_display }}
                                </span>
                            </td>
                            <td>
                                {% if doacao.comprovante %}
                                <a href="{{ doacao.comprovante.url }}" target="_blank" class="link-comprovante">
                                    <i class="fas fa-file-download"></i> Download
                                </a>
                                {% else %}
                                N/A
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5">Nenhuma doação registrada ainda.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.querySelectorAll('.navegacao-lateral a').forEach(link => {
    link.addEventListener('click', function(e) {
        if (!this.getAttribute('href')) {
            e.preventDefault();
            const secaoId = this.getAttribute('data-secao');
            
            document.querySelectorAll('.navegacao-lateral a').forEach(linkNav => {
                linkNav.classList.remove('ativo');
            });
            
            this.classList.add('ativo');
            
            document.querySelectorAll('.secao-conteudo').forEach(secao => {
                secao.classList.remove('ativo');
            });
            
            document.getElementById(secaoId).classList.add('ativo');
        }
    });
});

const ctx = document.getElementById('grafico-impacto').getContext('2d');
const graficoImpacto = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Últimos 6 meses'],
        datasets: [{
            label: 'Valor Doado (R$)',
            data: [{{ total_doacoes }}],
            backgroundColor: 'rgba(58, 159, 231, 0.7)',
            borderColor: 'rgba(58, 159, 231, 1)',
            borderWidth: 1
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Valor (R$)'
                }
            }
        },
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return 'R$ ' + context.raw.toLocaleString('pt-BR', {minimumFractionDigits: 2});
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}